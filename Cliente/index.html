<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Armários</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./css/main.css">
</head>
<body>

<!-- Barra de navegação -->
<nav>
    <div><strong>Controle de Estoque</strong></div>
    <div class="nav-links">
        <a href="entrada.html">Entrada de Produto</a>
        <a href="saida.html">Saída de Produto</a>
        <a href="pesquisa.html">Pesquisa de Produto</a>
        <a href="locais.html">Cadastro de Locais</a>
    </div>
</nav>

<h1>Controle de Estoque</h1>

<div id="armario-container" class="armario-container">
    <!-- Conteúdo dinâmico dos armários será inserido aqui -->
</div>

<script>
    // Simulação de dados do servidor
    // const dadosArmarios = [
    //     { 
    //         id: 1, 
    //         totalValor: 15000, 
    //         maiorSobressalente: { nome: "Peça A", valor: 5000 },
    //         totalPorEquipamento: { "Equipamento 1": 7000, "Equipamento 2": 8000 }
    //     },
    //     { 
    //         id: 2, 
    //         totalValor: 20000, 
    //         maiorSobressalente: { nome: "Peça B", valor: 7000 },
    //         totalPorEquipamento: { "Equipamento 1": 10000, "Equipamento 2": 10000 }
    //     },
    // ];

    var DADOS_ARMARIO = []
    async function consultaArmarios() {
        const armarios = await fetch('/consulta/armarios').then(res => res.json()).then(json => json)
        for (armario of armarios) {
            atualizaListaArmarios(armario);
        }
    }
    consultaArmarios();

    async function atualizaListaArmarios(armario) {
        const codigoArmario = armario.codigo
        const produtosArmario = await fetch(`/consulta/armario/${codigoArmario}`).then(res => res.json()).then(json => json)
        let valorTotalArmario = 0;
        let produtoMaiorValor = {
            valorMedio: 0
        }
        let valorTotalEquipamento = {}
        for (produto of produtosArmario) {
            valorTotalArmario += (produto.quantidade * produto.valorMedio)

            if (produto.valorMedio > produtoMaiorValor.valorMedio) {
                produtoMaiorValor = produto;
            }

            if (!valorTotalEquipamento[produto.equipamento]) {

                valorTotalEquipamento[produto.equipamento] = {
                    equipamento: produto.equipamento,
                    valor: (produto.quantidade * produto.valorMedio)
                }
            } else {
                valorTotalEquipamento[produto.equipamento].valor += produto.quantidade * produto.valorMedio
            }

        }

        const dadosArmario = {
            id: armario.nome,
            totalValor: valorTotalArmario.toFixed(2),
            maiorSobressalente: {
            nome: produtoMaiorValor.descricao,
            valor: produtoMaiorValor.valorMedio
            },
            totalPorEquipamento: {}
        } 

    const equipamentos = Object.keys(valorTotalEquipamento);
    for (equipamento of equipamentos) {
        dadosArmario.totalPorEquipamento[equipamento] = valorTotalEquipamento[equipamento].valor.toFixed(2);
    }
    DADOS_ARMARIO.push(dadosArmario)
    criarCardArmario(dadosArmario)
}

    function criarCardArmario(armario) {
        const armarioCard = document.createElement('div');
        armarioCard.className = 'armario-card';

        armarioCard.innerHTML = `
            <h3>${armario.id}</h3></br>
            <p><strong>Total:</strong> R$ ${armario.totalValor}</p></br>    
            <p><strong>Sobressalente de mais valor:</strong> ${armario.maiorSobressalente.nome} (R$ ${armario.maiorSobressalente.valor.toFixed(2)})</p></br>
            <div class="chart-container">
                <canvas id="chart-${armario.id}"></canvas>
            </div>
        `;

        document.getElementById('armario-container').appendChild(armarioCard);

        criarGrafico(armario);
    }

    function criarGrafico(armario) {
        const ctx = document.getElementById(`chart-${armario.id}`).getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(armario.totalPorEquipamento),
                datasets: [{
                    label: 'Valor por Equipamento',
                    data: Object.values(armario.totalPorEquipamento),
                    backgroundColor: ['#007bff', '#6c757d', '#adb5bd'],
                    hoverOffset: 4
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
</script>

</body>
</html>
