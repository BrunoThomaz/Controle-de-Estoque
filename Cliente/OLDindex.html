<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <title>Controle de Estoque - Cadastro</title>
</head>
<body>
    <div class="content">   
        <div class="header">
            <nav>
                <a href="/index.html">Tela Inicial</a>
                <a href="/entrada.html">Entrada de Produtos</a>
                <a href="/saida.html">Saída de Produtos</a>
                <a href="/pesquisa.html">Pesquisa de Produtos</a>
                <a href="/locais.html">Cadastro Locais</a>
            </nav>
        </div>
        <main>
            <div class="armario">
                <select name="armarios" id="armarios" onchange="atualizaListaArmarios()">
                    <option value="">Selecione um armário</option>
                </select>
                <div id="resultadoArmario"></div>
            </div>
            <script>
                var DADOS_ARMARIO = []
                async function consultaArmarios() {
                    const armarios = await fetch('/consulta/armarios').then(res => res.json()).then(json => json)
                    for (armario of armarios) {
                        atualizaListaArmarios(armario.codigo);
                    }
                }
                consultaArmarios();
                async function atualizaListaArmarios(codigoArmario) {
                    const produtosArmario = await fetch(`/consulta/armario/${codigoArmario}`).then(res => res.json()).then(json => json)
                    let valorTotalArmario = 0;
                    let produtoMaiorValor = {
                        valorMedio: 0
                    }
                    let valorTotalEquipamento = {}
                    for (produto of produtosArmario) {
                        valorTotalArmario += (produto.quantidade * produto.valorMedio)
        
                        if (produto.valorMedio > produtoMaiorValor.valorMedio) {
                            produtoMaiorValor = produto;
                        }
        
                        if (!valorTotalEquipamento[produto.equipamento]) {
        
                            valorTotalEquipamento[produto.equipamento] = {
                                equipamento: produto.equipamento,
                                valor: (produto.quantidade * produto.valorMedio)
                            }
                        } else {
                            valorTotalEquipamento[produto.equipamento].valor += produto.quantidade * produto.valorMedio
                        }
        
                    }
        //             { 
        //     id: 1, 
        //     totalValor: 15000, 
        //     maiorSobressalente: { nome: "Peça A", valor: 5000 },
        //     totalPorEquipamento: { "Equipamento 1": 7000, "Equipamento 2": 8000 }
        // }    
                    const dadosArmario = {
                        id: DADOS_ARMARIO.length,
                        totalValor: valorTotalArmario.toFixed(2),
                        maiorSobressalente: {
                            nome: produtoMaiorValor.descricao,
                            valor: produtoMaiorValor.valorMedio
                        },
                        totalPorEquipamento: {

                        }
                    } 
                    const resultadoArmario = document.getElementById('resultadoArmario')
                    resultadoArmario.innerHTML = ``;
                    resultadoArmario.innerHTML += `Valor total no armário: R$ ${valorTotalArmario.toFixed(2)}<br><br>`;
                    resultadoArmario.innerHTML += `Sobressalente de maior valor: <br>Código: ${produtoMaiorValor.codigo}<br>
                                                                                    Descrição: ${produtoMaiorValor.descricao}<br>
                                                                                    Equipamento: ${produtoMaiorValor.equipamento}<br>
                                                                                    Valor: ${produtoMaiorValor.valorMedio}<br><br>`;
                    resultadoArmario.innerHTML += `Orçamento por equipamento:<br>`
                    const equipamentos = Object.keys(valorTotalEquipamento);
                    for (equipamento of equipamentos) {
                        dadosArmario.totalPorEquipamento[equipamento] = valorTotalEquipamento[equipamento].valor.toFixed(2)
                        resultadoArmario.innerHTML += `Equipamento: ${equipamento}<br>`
                        resultadoArmario.innerHTML += `Valor: ${valorTotalEquipamento[equipamento].valor.toFixed(2)}<br><br>`
        
                    }
                    DADOS_ARMARIO.push(dadosArmario)
                    console.log(DADOS_ARMARIO)
                }
            </script>
        </main>
    </div>
</body>
</html>